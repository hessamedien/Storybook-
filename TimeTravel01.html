<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سفر در زمان: ملاقات با تاریخ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vazirmatn@33.003/Vazirmatn-font-face.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --accent-color: #e94560;
            --text-color: #f0f0f0;
            --background-color: #0f0f1b;
            --card-bg: rgba(26, 26, 46, 0.9);
            --hover-color: #4cc9f0;
            --success-color: #2ebf91;
            --warning-color: #f9c74f;
            --font-size: 18px;
            --transition-speed: 0.4s;
            --glow-color: rgba(236, 100, 75, 0.5);
        }

        [data-theme="light"] {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --text-color: #2c3e50;
            --background-color: #ecf0f1;
            --card-bg: rgba(255, 255, 255, 0.95);
            --hover-color: #1abc9c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --glow-color: rgba(41, 128, 185, 0.3);
        }

        [data-theme="blue"] {
            --primary-color: #0c2461;
            --secondary-color: #1e3799;
            --accent-color: #4bcffa;
            --text-color: #dff9fb;
            --background-color: #0a3d62;
            --card-bg: rgba(30, 55, 153, 0.9);
            --hover-color: #38ada9;
            --success-color: #78e08f;
            --warning-color: #f6b93b;
            --glow-color: rgba(75, 207, 250, 0.4);
        }

        [data-theme="ancient"] {
            --primary-color: #3d3b30;
            --secondary-color: #875c39;
            --accent-color: #c5a880;
            --text-color: #e6dbc9;
            --background-color: #2a2a28;
            --card-bg: rgba(99, 84, 71, 0.95);
            --hover-color: #a77c4f;
            --success-color: #8fa382;
            --warning-color: #c5a880;
            --glow-color: rgba(197, 168, 128, 0.4);
        }

        [data-theme="hakhmaneshi"] {
            --primary-color: #3d3b30;
            --secondary-color: #875c39;
            --accent-color: #c5a880;
            --text-color: #e6dbc9;
            --background-color: #2a2a28;
            --card-bg: rgba(99, 84, 71, 0.95);
            --hover-color: #a77c4f;
            --success-color: #8fa382;
            --warning-color: #c5a880;
            --glow-color: rgba(197, 168, 128, 0.4);
        }

        [data-theme="sasani"] {
            --primary-color: #0c2461;
            --secondary-color: #1e3799;
            --accent-color: #4bcffa;
            --text-color: #dff9fb;
            --background-color: #0a3d62;
            --card-bg: rgba(30, 55, 153, 0.9);
            --hover-color: #38ada9;
            --success-color: #78e08f;
            --warning-color: #f6b93b;
            --glow-color: rgba(75, 207, 250, 0.4);
        }

        [data-theme="ghajar"] {
            --primary-color: #3d3b30;
            --secondary-color: #6D214F;
            --accent-color: #EAB543;
            --text-color: #e6dbc9;
            --background-color: #2a2a28;
            --card-bg: rgba(109, 33, 79, 0.9);
            --hover-color: #a77c4f;
            --success-color: #8fa382;
            --warning-color: #c5a880;
            --glow-color: rgba(234, 181, 67, 0.4);
        }

        [data-theme="pahlavi"] {
            --primary-color: #2c2c54;
            --secondary-color: #474787;
            --accent-color: #706fd3;
            --text-color: #dff9fb;
            --background-color: #0a3d62;
            --card-bg: rgba(71, 71, 135, 0.9);
            --hover-color: #38ada9;
            --success-color: #78e08f;
            --warning-color: #f6b93b;
            --glow-color: rgba(112, 111, 211, 0.4);
        }

        [data-theme="safavid"] {
            --primary-color: #3d3b30;
            --secondary-color: #6D214F;
            --accent-color: #EAB543;
            --text-color: #e6dbc9;
            --background-color: #2a2a28;
            --card-bg: rgba(109, 33, 79, 0.9);
            --hover-color: #a77c4f;
            --success-color: #8fa382;
            --warning-color: #c5a880;
            --glow-color: rgba(234, 181, 67, 0.4);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.8;
            font-size: var(--font-size);
            transition: all var(--transition-speed) ease;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            background-image: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            animation: headerGlow 3s infinite alternate;
        }

        @keyframes headerGlow {
            0% {
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            }
            100% {
                box-shadow: 0 8px 30px var(--glow-color);
            }
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(to right, var(--accent-color), var(--hover-color), var(--success-color));
            border-radius: 15px 15px 0 0;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: var(--accent-color);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.6);
            background: linear-gradient(to right, var(--accent-color), var(--hover-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }

        h2 {
            font-size: 2rem;
            margin: 20px 0;
            color: var(--accent-color);
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
        }

        h3 {
            font-size: 1.6rem;
            margin: 15px 0;
            color: var(--hover-color);
        }

        h4 {
            font-size: 1.3rem;
            margin: 12px 0;
            color: var(--success-color);
        }

        .screen {
            display: none;
            background-color: var(--card-bg);
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            margin-bottom: 25px;
            flex-grow: 1;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .screen:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }

        #start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Starfield_Simulation.gif/640px-Starfield_Simulation.gif') center/cover no-repeat, var(--card-bg);
            background-blend-mode: overlay;
            min-height: 70vh;
            position: relative;
        }

        #start-screen::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 0;
        }

        #start-screen > * {
            position: relative;
            z-index: 1;
        }

        .btn {
            background: linear-gradient(to right, var(--accent-color), var(--hover-color));
            color: white;
            border: none;
            padding: 16px 35px;
            margin: 15px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
            z-index: -1;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }

        .btn:active {
            transform: translateY(2px);
        }

        .choice-btn {
            display: block;
            width: 100%;
            text-align: right;
            background: linear-gradient(to left, var(--secondary-color), var(--primary-color));
            margin: 18px 0;
            padding: 18px;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            color: var(--text-color);
            font-size: 1.1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .choice-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 12px solid var(--text-color);
            opacity: 0.7;
        }

        .choice-btn:hover {
            background: linear-gradient(to left, var(--hover-color), var(--accent-color));
            transform: translateX(-10px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .story-text {
            margin-bottom: 35px;
            line-height: 2.2;
            text-align: justify;
            font-size: 1.25rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            border-left: 4px solid var(--accent-color);
        }

        .character {
            font-weight: bold;
            color: var(--accent-color);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
        }

        .story-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .story-image:hover {
            transform: scale(1.02);
        }

        .settings-icon {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-color);
            z-index: 1000;
            background: var(--card-bg);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .settings-icon:hover {
            transform: rotate(45deg);
            color: var(--accent-color);
        }

        .settings-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-bg);
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            width: 85%;
            max-width: 550px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-option {
            margin: 18px 0;
        }

        .settings-option label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .close-settings {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .close-settings:hover {
            color: var(--accent-color);
            transform: scale(1.2);
        }

        .history-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin: 12px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid var(--hover-color);
        }

        .history-item:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }

        .footer {
            text-align: center;
            margin-top: 35px;
            padding: 25px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            margin: 12px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255, 94, 87, 0.5);
        }

        .social-share {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .social-btn {
            padding: 12px 25px;
            border-radius: 8px;
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .social-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to right, var(--accent-color), var(--hover-color));
        }

        .progress-bar {
            height: 12px;
            background-color: var(--secondary-color);
            border-radius: 10px;
            margin: 25px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--accent-color), var(--hover-color));
            width: 0%;
            transition: width 0.7s ease;
            border-radius: 10px;
        }

        .achievement {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid var(--accent-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .time-period {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }

        .period-btn {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            border-radius: 10px;
            background: linear-gradient(to bottom, var(--secondary-color), var(--primary-color));
            color: white;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .period-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(255, 255, 255, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .period-btn:hover::before {
            opacity: 1;
        }

        .period-btn:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
            border-color: var(--accent-color);
            background: linear-gradient(to bottom, var(--accent-color), var(--hover-color));
        }

        .stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
            min-width: 150px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 5px 0;
        }

        .music-player {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        .music-control {
            background-color: var(--secondary-color);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .music-control:hover {
            background-color: var(--accent-color);
            transform: scale(1.1);
        }

        /* موبایل ریسپانسیو */
        @media (max-width: 768px) {
            :root {
                --font-size: 16px;
            }

            h1 {
                font-size: 2.2rem;
            }

            h2 {
                font-size: 1.7rem;
            }

            h3 {
                font-size: 1.4rem;
            }

            .container {
                padding: 10px;
            }

            .screen {
                padding: 20px;
            }

            .btn {
                padding: 14px 25px;
                font-size: 1rem;
            }

            .period-btn {
                min-width: 100%;
            }

            .settings-panel {
                width: 95%;
                padding: 20px;
            }
        }

        /* انیمیشن‌ها */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.7s ease forwards;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* استایل برای حالت چاپ */
        @media print {
            body {
                background: white;
                color: black;
                font-size: 12pt;
            }

            .screen:not(#end-screen) {
                display: none !important;
            }

            .btn, .settings-icon, .social-share, .progress-bar, .choice-btn {
                display: none;
            }

            #end-screen {
                box-shadow: none;
                background: white;
                color: black;
                padding: 20px;
            }

            .achievement {
                border: 1px solid #ddd;
                background: white;
                color: black;
            }
        }

        /* افکت تایپ کردن */
        .typewriter {
            overflow: hidden;
            border-right: 3px solid var(--accent-color);
            white-space: nowrap;
            margin: 0 auto;
            animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--accent-color) }
        }

        /* افکت پارالاکس */
        .parallax-bg {
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }

        /* دکمة بازگشت */
        .back-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 15px 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background-color: var(--accent-color);
            transform: translateX(-5px);
        }

        /* لودینگ */
        .loader {
            border: 5px solid var(--secondary-color);
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            text-align: center;
            margin: 10px 0;
        }

        /* سیستم امتیازدهی */
        .score-system {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-value {
            font-weight: bold;
            color: var(--accent-color);
        }

        /* پاپ آپ دستاورد */
        .achievement-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(100%);
            transition: transform 0.5s ease;
            border-left: 4px solid var(--accent-color);
        }

        .achievement-popup.show {
            transform: translateX(0);
        }

        .achievement-icon {
            font-size: 24px;
            color: var(--accent-color);
        }

        /* صفحه بارگذاری */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-title {
            margin-bottom: 20px;
            font-size: 1.5rem;
            color: var(--accent-color);
        }

        /* افکت‌های ویژه */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: var(--accent-color);
            border-radius: 50%;
            opacity: 0.3;
            animation: float 15s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0.3;
            }
            100% {
                transform: translateY(-100vh) translateX(100vw) rotate(360deg);
                opacity: 0;
            }
        }

        /* دکمه‌های جدید */
        .quick-actions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 999;
        }

        .action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            color: var(--text-color);
            font-size: 20px;
        }

        .action-btn:hover {
            background: var(--accent-color);
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    
    <div class="score-system">
        <i class="fas fa-star"></i>
        <span>امتیاز: </span>
        <span class="score-value" id="score-value">0</span>
    </div>

    <div class="achievement-popup" id="achievement-popup">
        <div class="achievement-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <div class="achievement-content">
            <div class="achievement-title" id="achievement-title"></div>
            <div class="achievement-desc" id="achievement-desc"></div>
        </div>
    </div>

    <div class="quick-actions">
        <div class="action-btn" id="save-game-btn" title="ذخیره بازی">
            <i class="fas fa-save"></i>
        </div>
        <div class="action-btn" id="load-game-btn" title="بارگذاری بازی">
            <i class="fas fa-folder-open"></i>
        </div>
        <div class="action-btn" id="help-btn" title="راهنما">
            <i class="fas fa-question"></i>
        </div>
    </div>

    <div class="container">
        <i class="fas fa-cog settings-icon" id="settings-icon"></i>

        <header>
            <h1>سفر در زمان: ملاقات با تاریخ</h1>
            <p>ساخته شده توسط حسام‌الدین</p>
            <p id="version-display">ورژن: ۲.۰.۰ (مهر ۱۴۰۲)</p>
        </header>

        <div class="screen" id="start-screen">
            <h2 class="typewriter">به ماشین زمان خوش آمدید!</h2>
            <p>در این بازی ماجراجویی، شما به گذشته سفر خواهید کرد و با شخصیت‌های تاریخی مهم ایران ملاقات خواهید کرد.</p>
            <p>هر تصمیمی که می‌گیرید، بر روند تاریخ تأثیر خواهد گذاشت و داستان را به سمتی متفاوت خواهد برد.</p>
            <p>آماده‌اید تا تاریخ را تغییر دهید؟</p>
            <button class="btn pulse" id="start-btn">شروع ماجراجویی</button>
            <div class="progress-bar">
                <div class="progress" id="progress-bar"></div>
            </div>
        </div>

        <div class="screen" id="name-screen">
            <h2>لطفاً اطلاعات خود را وارد کنید</h2>
            <div class="settings-option">
                <label for="player-name">نام شما:</label>
                <input type="text" id="player-name" placeholder="نام خود را وارد کنید">
            </div>
            <div class="settings-option">
                <label for="player-gender">جنسیت:</label>
                <select id="player-gender">
                    <option value="male">مرد</option>
                    <option value="female">زن</option>
                </select>
            </div>
            <div class="settings-option">
                <label for="player-age">سن شما:</label>
                <input type="number" id="player-age" placeholder="سن خود را وارد کنید" min="10" max="100">
            </div>
            <button class="btn" id="name-submit">ادامه</button>
        </div>

        <div class="screen" id="era-screen">
            <h2>به کدام دوره تاریخی می‌خواهید سفر کنید؟</h2>
            <p>هر دوره تاریخی دارای چالش‌ها و فرصت‌های منحصر به فرد خود است. انتخاب شما سرنوشت تاریخ را تغییر خواهد داد.</p>
            
            <div class="time-period">
                <div class="period-btn" data-era="hakhmaneshi">دوره هخامنشیان<br><small>۵۵۰ تا ۳۳۰ قبل از میلاد</small></div>
                <div class="period-btn" data-era="sasani">دوره ساسانیان<br><small>۲۲۴ تا ۶۵۱ میلادی</small></div>
                <div class="period-btn" data-era="safavid">دوره صفویه<br><small>۱۵۰۱ تا ۱۷۳۶ میلادی</small></div>
                <div class="period-btn" data-era="ghajar">دوره قاجار<br><small>۱۷۸۹ تا ۱۹۲۵ میلادی</small></div>
                <div class="period-btn" data-era="pahlavi">دوره پهلوی<br><small>۱۹۲۵ تا ۱۹۷۹ میلادی</small></div>
                <div class="period-btn" data-era="special">دوره‌های خاص<br><small>سفر به لحظات تعیین‌کننده</small></div>
            </div>

            <button class="back-btn" id="era-back"><i class="fas fa-arrow-right"></i> بازگشت</button>
        </div>

        <div class="screen" id="game-screen">
            <div class="story-text" id="story-text">
                <!-- محتوای داستان در اینجا نمایش داده می‌شود -->
            </div>
            <div id="story-image-container">
                <!-- تصاویر داستان در اینجا نمایش داده می‌شوند -->
            </div>
            <div id="choices-container">
                <!-- گزینه‌ها در اینجا نمایش داده می‌شوند -->
            </div>
            <div class="progress-bar">
                <div class="progress" id="game-progress"></div>
            </div>
            <button class="back-btn" id="game-back"><i class="fas fa-arrow-right"></i> بازگشت به انتخاب دوره</button>
        </div>

        <div class="screen" id="end-screen">
            <h2 id="end-title">پایان داستان</h2>
            <div id="end-content">
                <!-- محتوای پایان داستان در اینجا نمایش داده می‌شود -->
            </div>
            <div class="social-share">
                <button class="social-btn" id="print-btn"><i class="fas fa-print"></i> چاپ داستان</button>
                <button class="social-btn" id="save-btn"><i class="fas fa-download"></i> ذخیره داستان</button>
                <button class="social-btn" id="share-btn"><i class="fas fa-share-alt"></i> اشتراک گذاری</button>
                <button class="social-btn" id="restart-btn"><i class="fas fa-redo"></i> شروع مجدد</button>
            </div>
        </div>

        <div class="settings-panel" id="settings-panel">
            <i class="fas fa-times close-settings" id="close-settings"></i>
            <h2>تنظیمات بازی</h2>
            
            <div class="settings-option">
                <label for="theme-select">تم:</label>
                <select id="theme-select">
                    <option value="dark">تیره (پیشفرض)</option>
                    <option value="light">روشن</option>
                    <option value="blue">آبی</option>
                    <option value="ancient">باستانی</option>
                </select>
            </div>
            
            <div class="settings-option">
                <label for="font-size">اندازه فونت:</label>
                <input type="range" id="font-size" min="14" max="24" value="18">
                <span id="font-size-value">18px</span>
            </div>
            
            <div class="settings-option">
                <label for="font-family">نوع فونت:</label>
                <select id="font-family">
                    <option value="Vazirmatn">Vazirmatn (پیشفرض)</option>
                    <option value="Segoe UI">Segoe UI</option>
                    <option value="Tahoma">Tahoma</option>
                    <option value="Arial">Arial</option>
                </select>
            </div>
            
            <div class="settings-option">
                <label>موسیقی زمینه:</label>
                <div class="music-player">
                    <div class="music-control" id="music-prev"><i class="fas fa-step-backward"></i></div>
                    <div class="music-control" id="music-play"><i class="fas fa-play"></i></div>
                    <div class="music-control" id="music-next"><i class="fas fa-step-forward"></i></div>
                    <input type="range" id="bg-music" min="0" max="100" value="50" style="flex-grow: 1;">
                </div>
                <select id="music-select" style="width: 100%; margin-top: 10px;">
                    <option value="none">بدون موسیقی</option>
                    <option value="historical1">موسیقی تاریخی ۱</option>
                    <option value="historical2">موسیقی تاریخی ۲</option>
                    <option value="epic">موسیقی حماسی</option>
                    <option value="meditative">موسیقی مراقبه</option>
                </select>
            </div>
            
            <div class="settings-option">
                <label for="sound-effects">افکت‌های صوتی:</label>
                <input type="range" id="sound-effects" min="0" max="100" value="80">
                <span id="sound-effects-value">80%</span>
            </div>
            
            <div class="settings-option">
                <label>
                    <input type="checkbox" id="auto-scroll" checked> اسکرول خودکار
                </label>
            </div>
            
            <div class="settings-option">
                <label>
                    <input type="checkbox" id="animation-effects" checked> افکت‌های انیمیشن
                </label>
            </div>
            
            <div class="settings-option">
                <label>
                    <input type="checkbox" id="online-resources"> استفاده از منابع آنلاین (در صورت اتصال به اینترنت)
                </label>
            </div>
            
            <div class="settings-option">
                <label for="image-quality">کیفیت تصاویر:</label>
                <select id="image-quality">
                    <option value="low">پایین (بارگیری سریعتر)</option>
                    <option value="medium">متوسط</option>
                    <option value="high">بالا (کیفیت بهتر)</option>
                </select>
            </div>
            
            <div class="settings-option">
                <label for="difficulty">سطح دشواری:</label>
                <select id="difficulty">
                    <option value="easy">آسان</option>
                    <option value="normal">عادی</option>
                    <option value="hard">سخت</option>
                </select>
            </div>
            
            <div class="settings-option">
                <label for="autosave">ذخیره خودکار هر:</label>
                <select id="autosave">
                    <option value="0">غیرفعال</option>
                    <option value="5">۵ دقیقه</option>
                    <option value="10">۱۰ دقیقه</option>
                    <option value="15">۱۵ دقیقه</option>
                </select>
            </div>
            
            <button class="btn" id="save-settings">ذخیره تنظیمات</button>
            <button class="btn" id="reset-settings" style="background: var(--secondary-color); margin-top: 10px;">بازنشانی تنظیمات</button>
        </div>

        <div class="footer">
            <p>ساخته شده با ♥ توسط حسام‌الدین</p>
            <p>صفحه اینستاگرام: <a href="https://instagram.com/hessamedien" style="color: var(--accent-color);">hessamedien</a></p>
            <p>تمامی حقوق محفوظ است © ۱۴۰۲</p>
        </div>
    </div>

    <audio id="background-music" loop>
        <source src="" type="audio/mpeg">
        مرورگر شما از پخش موسیقی پشتیبانی نمی‌کند.
    </audio>

    <script>
        // داده‌های بازی - بسیار گسترده‌تر شده
        const gameData = {
            playerName: "",
            playerGender: "male",
            playerAge: 25,
            currentChapter: "start",
            selectedEra: "",
            history: [],
            achievements: [],
            choices: [],
            score: 0,
            inventory: [],
            settings: {
                theme: "dark",
                fontSize: 18,
                fontFamily: "Vazirmatn",
                bgMusic: 50,
                soundEffects: 80,
                autoScroll: true,
                animationEffects: true,
                onlineResources: false,
                imageQuality: "medium",
                selectedMusic: "none",
                difficulty: "normal",
                autosave: 5
            },
            stats: {
                chaptersVisited: 0,
                choicesMade: 0,
                eraChanges: 0,
                timeSpent: 0,
                achievementsUnlocked: 0,
                scoreEarned: 0
            },
            music: {
                isPlaying: false,
                currentTrack: null,
                tracks: {
                    historical1: "https://upload.wikimedia.org/wikipedia/commons/transcoded/4/4d/Ancient_Persian_Music_-_Kourosh_Yaghmaei_-_Morghe_Sahra.ogg/Ancient_Persian_Music_-_Kourosh_Yaghmaei_-_Morghe_Sahra.ogg.mp3",
                    historical2: "https://upload.wikimedia.org/wikipedia/commons/transcoded/6/6f/Ancient_Persian_Music_-_Kourosh_Yaghmaei_-_Gole_Gold.ogg/Ancient_Persian_Music_-_Kourosh_Yaghmaei_-_Gole_Gold.ogg.mp3",
                    epic: "https://upload.wikimedia.org/wikipedia/commons/transcoded/0/0a/Epic_Battle_Music_-_Two_Steps_From_Hell_-_Strength_of_a_Thousand_Men.ogg/Epic_Battle_Music_-_Two_Steps_From_Hell_-_Strength_of_a_Thousand_Men.ogg.mp3",
                    meditative: "https://upload.wikimedia.org/wikipedia/commons/transcoded/5/5c/Desert_Song_-_The_Desert_Drones.ogg/Desert_Song_-_The_Desert_Drones.ogg.mp3"
                }
            },
            onlineResources: {
                images: {
                    hakhmaneshi: [
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Persepolis_04.jpg/800px-Persepolis_04.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Cyrus_II_le_Grand_et_les_Hébreux.jpg/800px-Cyrus_II_le_Grand_et_les_Hébreux.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Tomb_of_Cyrus_II.jpg/800px-Tomb_of_Cyrus_II.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/d/df/Cyrus_cylinder_-_British_Museum.jpg/800px-Cyrus_cylinder_-_British_Museum.jpg"
                    ],
                    sasani: [
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Taq-e_Bostan_-_High-relief_of_Ardashir_II.jpg/800px-Taq-e_Bostan_-_High-relief_of_Ardashir_II.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9d/Sassanid_Empire_620.png/800px-Sassanid_Empire_620.png",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Naqsh-e_Rostam_7.jpg/800px-Naqsh-e_Rostam_7.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Sassanian_plate_5th_century.jpg/800px-Sassanian_plate_5th_century.jpg"
                    ],
                    safavid: [
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Shah_Abbas_I_-_Safavid_King.jpg/800px-Shah_Abbas_I_-_Safavid_King.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Isfahan_Naqsh-e_Jahan_Square.jpg/800px-Isfahan_Naqsh-e_Jahan_Square.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Safavid_carpet.jpg/800px-Safavid_carpet.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/7/7e/Ali_Qapu_2.jpg/800px-Ali_Qapu_2.jpg"
                    ],
                    ghajar: [
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Nasser_al-Din_Shah_during_his_first_European_tour.jpg/800px-Nasser_al-Din_Shah_during_his_first_European_tour.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Golestan_palace_3.jpg/800px-Golestan_palace_3.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/19th_century_Iranian_street_photography.jpg/800px-19th_century_Iranian_street_photography.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/Constitutional_Revolution_of_Iran.jpg/800px-Constitutional_Revolution_of_Iran.jpg"
                    ],
                    pahlavi: [
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Reza_Shah_Pahlavi.jpg/800px-Reza_Shah_Pahlavi.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Coronation_of_Mohammad_Reza_Pahlavi.jpg/800px-Coronation_of_Mohammad_Reza_Pahlavi.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/White_Revolution_land_reform.jpg/800px-White_Revolution_land_reform.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Shahyad_Tower_in_1970s.jpg/800px-Shahyad_Tower_in_1970s.jpg"
                    ],
                    special: [
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Avicenna.jpg/800px-Avicenna.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Omar_Khayyam%2C_Portrait.png/800px-Omar_Khayyam%2C_Portrait.png",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Ferdowsi_1.jpg/800px-Ferdowsi_1.jpg",
                        "https://upload.wikimedia.org/wikipedia/commons/thumb/7/7e/Hafez.jpg/800px-Hafez.jpg"
                    ]
                },
                sounds: {
                    click: "https://upload.wikimedia.org/wikipedia/commons/c/c5/Button_click.ogg",
                    success: "https://upload.wikimedia.org/wikipedia/commons/2/21/Beep-07.ogg",
                    failure: "https://upload.wikimedia.org/wikipedia/commons/5/5c/Beep-09.ogg",
                    transition: "https://upload.wikimedia.org/wikipedia/commons/e/e5/Time_machine_sound_effect.ogg",
                    achievement: "https://upload.wikimedia.org/wikipedia/commons/6/6d/Service_bell_ringing.ogg",
                    sword: "https://upload.wikimedia.org/wikipedia/commons/4/45/Sword_clash.wav",
                    magic: "https://upload.wikimedia.org/wikipedia/commons/b/bb/Magic_spell.ogg"
                }
            },
            achievementsList: {
                first_step: {
                    title: "اولین قدم",
                    description: "شروع سفر در زمان",
                    score: 10,
                    unlocked: false
                },
                historian: {
                    title: "تاریخ‌دان",
                    description: "بازدید از ۵ دوره تاریخی مختلف",
                    score: 50,
                    unlocked: false
                },
                time_guardian: {
                    title: "نگهبان زمان",
                    description: "تغییر ندادن خط زمانی اصلی",
                    score: 100,
                    unlocked: false
                },
                explorer: {
                    title: "کاشف",
                    description: "کشف تمام شاخه‌های داستانی یک دوره",
                    score: 75,
                    unlocked: false
                },
                master: {
                    title: "استاد سفر در زمان",
                    description: "کسب بیش از ۵۰۰ امتیاز",
                    score: 150,
                    unlocked: false
                }
            }
        };

        // داستان و فصل‌های بازی - بسیار گسترده‌تر شده
        const storyChapters = {
            start: {
                text: `در آزمایشگاه مخفی پروفسور احمدی، شما در مقابل دستگاهی پیچیده ایستاده‌اید. پروفسور با هیجان می‌گوید: "بالاخره ماشین زمان من کامل شد! تو اولین کسی هستی که این افتخار را داری که از آن استفاده کنی. می‌تونی به هر دوره تاریخی که می‌خوای سفر کنی و حتی تاریخ را تغییر بدی. اما مراقب باش، هر تغییر کوچیکی می‌تونه پیامدهای غیرقابل پیش‌بینی داشته باشه."`,
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Starfield_Simulation.gif/640px-Starfield_Simulation.gif",
                choices: [
                    { text: "کنترل ماشین زمان را به دست بگیر و به دوران کوروش بزرگ سفر کن", next: "cyrus", era: "hakhmaneshi", score: 5 },
                    { text: "برای ملاقات با فردوسی به دوران سامانیان برو", next: "ferdowsi", era: "special", score: 5 },
                    { text: "به دوران صفویه سفر کن و با شاه عباس ملاقات کن", next: "shah_abbas", era: "safavid", score: 5 },
                    { text: "به دوران قاجار سفر کن و نقشه‌های استعمارگران را خنثی کن", next: "ghajar_intro", era: "ghajar", score: 5 },
                    { text: "به دوران پهلوی برو و شاهد تحولات مدرن شدن ایران باش", next: "pahlavi_intro", era: "pahlavi", score: 5 },
                    { text: "ابتدا اطلاعات بیشتری درباره ماشین زمان بپرس", next: "machine_info", score: 2 }
                ]
            },
            
            machine_info: {
                text: `پروفسور احمدی با دقت توضیح می‌دهد: "این دستگاه می‌تونه تو را به هر نقطه از تاریخ بفرسته. اما چند قانون مهم وجود داره: اول اینکه نمی‌تونی چیزی از آینده را با خودت ببری. دوم اینکه نمی‌تونی هویت واقعی‌ات را فاش کنی. و سوم، هر تغییری که ایجاد کنی می‌تونه عواقب غیرمنتظره‌ای داشته باشه."`,
                choices: [
                    { text: "قوانین را پذیرفته و به دوران هخامنشیان سفر کن", next: "cyrus", era: "hakhmaneshi", score: 5 },
                    { text: "به دوران ساسانیان سفر کن", next: "sassanid_intro", era: "sasani", score: 5 },
                    { text: "در مورد خطرات بیشتر بپرس", next: "machine_dangers", score: 2 }
                ]
            },
            
            machine_dangers: {
                text: `پروفسور با نگرانی ادامه می‌دهد: "بزرگترین خطر اینه که ممکنه در زمان گیر بیفتی و نتونی برگردی. یا اینکه تغییراتی که ایجاد می‌کنی باعث بشه دنیای حاضر به کلی تغییر کنه. حتی ممکنه وجود خودت را از دست بدی اگر پدربزرگت رو به طور تصادفی از بین ببری!"`,
                choices: [
                    { text: "با آگاهی از خطرات به دوران هخامنشیان سفر کن", next: "cyrus", era: "hakhmaneshi", score: 10 },
                    { text: "به دوران صفویه سفر کن", next: "shah_abbas", era: "safavid", score: 10 },
                    { text: "بازگشت به صفحه اصلی", next: "start", score: 0 }
                ]
            },
            
            // دوره هخامنشیان - گسترش یافته
            cyrus: {
                text: `نور شدیدی شما را احاطه می‌کند و خود را در میان بیابانی وسیع می‌بینید. در دوردست، شهری با دیوارهای بلند قابل مشاهده است. کاروانی از کنار شما عبور می‌کند و یکی از مسافران به شما می‌گوید که اینجا پاسارگاد است و کوروش بزرگ در حال آماده‌سازی برای فتح بابل است.`,
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Tomb_of_Cyrus_II.jpg/800px-Tomb_of_Cyrus_II.jpg",
                choices: [
                    { text: "مستقیماً به دربار کوروش برو و خود را به عنوان سفیر آینده معرفی کن", next: "cyrus_court", score: 5 },
                    { text: "در شهر بگرد و اطلاعات جمع کن", next: "cyrus_city", score: 3 },
                    { text: "به کاروانی ملحق شو و راهی بابل شو", next: "cyrus_babylon", score: 5 },
                    { text: "به دنبال دانیال نبی برو که در دربار است", next: "cyrus_daniel", score: 7 }
                ]
            },
            
            cyrus_court: {
                text: `با گذشتن از نگهبانان، خود را در مقابل کوروش بزرگ می‌بینید. او با مهربانی اما با کنجکاوی به شما نگاه می‌کند. "تو از کجا آمده‌ای و چه می‌خواهی؟" می‌پرسد.`,
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Cyrus_II_le_Grand_et_les_Hébreux.jpg/800px-Cyrus_II_le_Grand_et_les_Hébreux.jpg",
                choices: [
                    { text: "حقیقت را بگو و از ماشین زمان و آینده بگو", next: "cyrus_truth", score: 10 },
                    { text: "خود را به عنوان یک مشاور از سرزمینی دور معرفی کن", next: "cyrus_advisor", score: 5 },
                    { text: "هدیه‌ای از آینده به او ارائه کن (سکه‌ای از دوران خودت)", next: "cyrus_gift", score: 7 },
                    { text: "ادعا کن که پیامی از طرف خدایان برای او آورده‌ای", next: "cyrus_gods", score: 8 }
                ]
            },
            
            cyrus_truth: {
                text: `کوروش با شنیدن داستان شما ابتدا متعجب می‌شود، اما سپس با خردمندی خاصی می‌گوید: "اگر تو از آینده می‌آیی، پس باید بدانی که من بر کل بین النهرین مسلط خواهم شد. اما آیا این حکومت پایدار خواهد ماند؟"`,
                choices: [
                    { text: "به او بگو که امپراتوری او پس از دو قرن سقوط خواهد کرد", next: "cyrus_fall", score: 15 },
                    { text: "از گفتن آینده خودداری کن و فقط او را تشویق به ادامه راهش کن", next: "cyrus_encourage", score: 5 },
                    { text: "پیشنهاد تغییر استراتژی جنگی به او بده", next: "cyrus_strategy", score: 10 },
                    { text: "در مورد اهمیت حقوق بشر و آزادی ادیان با او صحبت کن", next: "cyrus_human_rights", score: 12 }
                ]
            },
            
            // ادامه داستان هخامنشیان...
            
            // سایر دوره‌های تاریخی با جزئیات بیشتر...
            
            // پایان‌های مختلف
            ending_historical_preserved: {
                text: `با هوشمندی و دقت، شما موفق شدید تاریخ را بدون ایجاد تغییرات مخرب مشاهده کنید. شما به حال بازگشته‌اید و پروفسور احمدی از شما به خاطر مسئولیت‌پذیری‌تان تشکر می‌کند. تاریخ دست نخورده باقی مانده و شما داستان‌های زیادی برای تعریف کردن دارید.`,
                ending: "حافظ تاریخ",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/History_book_icon.png/800px-History_book_icon.png",
                score: 100
            },
            ending_butterfly_effect: {
                text: `متأسفانه، یک اقدام کوچک شما باعث تغییرات غیرقابل پیش‌بینی در تاریخ شده است. وقتی به حال بازگشتید، دنیایی کاملاً متفاوت را پیدا کردید. پروفسور احمدی ناامیدانه سعی می‌کند ماشین زمان را تعمیر کند تا تاریخ را به حالت اول بازگرداند. شما درس بزرگی در مورد مداخله در تاریخ یاد گرفته‌اید.`,
                ending: "اثر پروانه‌ای",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Butterfly_effect.png/800px-Butterfly_effect.png",
                score: 50
            },
            ending_hero: {
                text: `شما با شجاعت و درایت خود توانستید تغییرات مثبتی در تاریخ ایجاد کنید. وقتی به زمان حال بازگشتید، ایران به کشوری پیشرفته‌تر و مرفه‌تر تبدیل شده بود. مردم شما را به عنوان قهرمان ملی می‌شناسند و از شما به خاطر اقدامات‌تان تقدیر می‌کنند. پروفسور احمدی به شما افتخار می‌کند.`,
                ending: "قهرمان تاریخ",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Hero_icon.png/800px-Hero_icon.png",
                score: 200
            },
            ending_trapped: {
                text: `متأسفانه، در حین بازگشت به زمان حاضر، ماشین زمان دچار نقص فنی شد و شما در گذشته گیر افتاده‌اید. حالا باید در دوران تاریخی که انتخاب کرده‌اید زندگی کنید و امیدوار باشید که روزی راهی برای بازگشت پیدا کنید.`,
                ending: "در دام زمان",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Hourglass_icon.png/800px-Hourglass_icon.png",
                score: 75
            },
            ending_ruler: {
                text: `با استفاده از دانش آینده‌تان، شما توانستید به موقعیت قدرتمندی در گذشته دست پیدا کنید. شما حالا به عنوان حاکم جدید این دوران تاریخی حکومت می‌کنید و تاریخ را به کلی تغییر داده‌اید. اما آیا این تغییرات برای بهتر شدن است؟`,
                ending: "حاکم زمان",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Crown_icon.png/800px-Crown_icon.png",
                score: 150
            },
            ending_scholar: {
                text: `شما تصمیم گرفتید در گذشته بمانید و دانش خود را در اختیار مردم آن زمان قرار دهید. شما به عنوان بزرگترین دانشمند و فیلسوف تاریخ شناخته می‌شوید و تأثیرات teachings شما برای قرن‌ها ادامه خواهد یافت.`,
                ending: "دانشمند زمان",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Scholar_icon.png/800px-Scholar_icon.png",
                score: 175
            },
            // پایان‌های بیشتر...
            ending_time_guardian: {
                text: `شما به عنوان محافظ زمان انتخاب شده‌اید. پروفسور احمدی به شما می‌گوید که شما تنها کسی هستید که می‌توانید تعادل زمانی را حفظ کنید. شما حالا باید بین گذشته و حال سفر کنید و از تغییرات غیرقانونی در تاریخ جلوگیری کنید.`,
                ending: "محافظ زمان",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Shield_icon.png/800px-Shield_icon.png",
                score: 250
            },
            ending_wise: {
                text: `با خردمندی و درایت، شما نه تنها تاریخ را تغییر ندادید، بلکه دانش ارزشمندی از گذشته کسب کردید. شما حالا به عنوان بزرگترین مورخ جهان شناخته می‌شوید و کتاب‌های شما منبعی بی‌نظیر برای درک تاریخ هستند.`,
                ending: "فرزانه زمان",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Wise_icon.png/800px-Wise_icon.png",
                score: 180
            }
        };

        // عناصر DOM
        const startScreen = document.getElementById('start-screen');
        const nameScreen = document.getElementById('name-screen');
        const eraScreen = document.getElementById('era-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const storyText = document.getElementById('story-text');
        const storyImageContainer = document.getElementById('story-image-container');
        const choicesContainer = document.getElementById('choices-container');
        const startBtn = document.getElementById('start-btn');
        const nameSubmit = document.getElementById('name-submit');
        const playerNameInput = document.getElementById('player-name');
        const playerGenderSelect = document.getElementById('player-gender');
        const playerAgeInput = document.getElementById('player-age');
        const settingsIcon = document.getElementById('settings-icon');
        const settingsPanel = document.getElementById('settings-panel');
        const closeSettings = document.getElementById('close-settings');
        const saveSettings = document.getElementById('save-settings');
        const resetSettings = document.getElementById('reset-settings');
        const themeSelect = document.getElementById('theme-select');
        const fontSizeSlider = document.getElementById('font-size');
        const fontSizeValue = document.getElementById('font-size-value');
        const fontFamilySelect = document.getElementById('font-family');
        const bgMusicSlider = document.getElementById('bg-music');
        const soundEffectsSlider = document.getElementById('sound-effects');
        const soundEffectsValue = document.getElementById('sound-effects-value');
        const autoScrollCheckbox = document.getElementById('auto-scroll');
        const animationEffectsCheckbox = document.getElementById('animation-effects');
        const onlineResourcesCheckbox = document.getElementById('online-resources');
        const imageQualitySelect = document.getElementById('image-quality');
        const musicSelect = document.getElementById('music-select');
        const difficultySelect = document.getElementById('difficulty');
        const autosaveSelect = document.getElementById('autosave');
        const printBtn = document.getElementById('print-btn');
        const saveBtn = document.getElementById('save-btn');
        const shareBtn = document.getElementById('share-btn');
        const restartBtn = document.getElementById('restart-btn');
        const endTitle = document.getElementById('end-title');
        const endContent = document.getElementById('end-content');
        const gameProgress = document.getElementById('game-progress');
        const eraBackBtn = document.getElementById('era-back');
        const gameBackBtn = document.getElementById('game-back');
        const versionDisplay = document.getElementById('version-display');
        const periodButtons = document.querySelectorAll('.period-btn');
        const musicPlayBtn = document.getElementById('music-play');
        const musicPrevBtn = document.getElementById('music-prev');
        const musicNextBtn = document.getElementById('music-next');
        const backgroundMusic = document.getElementById('background-music');
        const scoreValue = document.getElementById('score-value');
        const achievementPopup = document.getElementById('achievement-popup');
        const achievementTitle = document.getElementById('achievement-title');
        const achievementDesc = document.getElementById('achievement-desc');
        const saveGameBtn = document.getElementById('save-game-btn');
        const loadGameBtn = document.getElementById('load-game-btn');
        const helpBtn = document.getElementById('help-btn');
        const particlesContainer = document.getElementById('particles');

        // تاریخ ساخت بازی برای نسخه
        const creationDate = new Date();
        const version = `ورژن: ۲.۰.۰ (${creationDate.getFullYear()}/${creationDate.getMonth()+1}/${creationDate.getDate()})`;
        versionDisplay.textContent = version;

        // ایجاد ذرات شناور
        function createParticles() {
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                
                const size = Math.random() * 5 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                
                particle.style.animationDuration = `${Math.random() * 20 + 10}s`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                
                particlesContainer.appendChild(particle);
            }
        }

        // نمایش پاپ آپ دستاورد
        function showAchievement(id) {
            const achievement = gameData.achievementsList[id];
            if (!achievement || achievement.unlocked) return;
            
            achievement.unlocked = true;
            gameData.achievements.push(id);
            gameData.stats.achievementsUnlocked++;
            addScore(achievement.score);
            
            achievementTitle.textContent = achievement.title;
            achievementDesc.textContent = achievement.description;
            
            achievementPopup.classList.add('show');
            playSound('achievement');
            
            setTimeout(() => {
                achievementPopup.classList.remove('show');
            }, 5000);
        }

        // اضافه کردن امتیاز
        function addScore(points) {
            gameData.score += points;
            gameData.stats.scoreEarned += points;
            scoreValue.textContent = gameData.score;
            
            // بررسی دستاوردهای مرتبط با امتیاز
            if (gameData.score >= 500 && !gameData.achievementsList.master.unlocked) {
                showAchievement('master');
            }
        }

        // رویدادهای کلیک
        startBtn.addEventListener('click', () => {
            startScreen.style.display = 'none';
            nameScreen.style.display = 'block';
            playSound('click');
        });

        nameSubmit.addEventListener('click', () => {
            gameData.playerName = playerNameInput.value || 'ناشناس';
            gameData.playerGender = playerGenderSelect.value;
            gameData.playerAge = playerAgeInput.value || 25;
            nameScreen.style.display = 'none';
            eraScreen.style.display = 'block';
            playSound('click');
            
            // دستاورد اولین قدم
            showAchievement('first_step');
        });

        eraBackBtn.addEventListener('click', () => {
            eraScreen.style.display = 'none';
            nameScreen.style.display = 'block';
            playSound('click');
        });

        gameBackBtn.addEventListener('click', () => {
            gameScreen.style.display = 'none';
            eraScreen.style.display = 'block';
            playSound('click');
        });

        // انتخاب دوره تاریخی
        periodButtons.forEach(button => {
            button.addEventListener('click', () => {
                gameData.selectedEra = button.getAttribute('data-era');
                eraScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                loadChapter('start');
                playSound('transition');
            });
        });

        settingsIcon.addEventListener('click', () => {
            settingsPanel.style.display = 'block';
            playSound('click');
        });

        closeSettings.addEventListener('click', () => {
            settingsPanel.style.display = 'none';
            playSound('click');
        });

        saveSettings.addEventListener('click', () => {
            gameData.settings.theme = themeSelect.value;
            gameData.settings.fontSize = fontSizeSlider.value;
            gameData.settings.fontFamily = fontFamilySelect.value;
            gameData.settings.bgMusic = bgMusicSlider.value;
            gameData.settings.soundEffects = soundEffectsSlider.value;
            gameData.settings.autoScroll = autoScrollCheckbox.checked;
            gameData.settings.animationEffects = animationEffectsCheckbox.checked;
            gameData.settings.onlineResources = onlineResourcesCheckbox.checked;
            gameData.settings.imageQuality = imageQualitySelect.value;
            gameData.settings.selectedMusic = musicSelect.value;
            gameData.settings.difficulty = difficultySelect.value;
            gameData.settings.autosave = autosaveSelect.value;
            
            applySettings();
            settingsPanel.style.display = 'none';
            playSound('success');
        });

        resetSettings.addEventListener('click', () => {
            if (confirm('آیا مطمئن هستید که می‌خواهید همه تنظیمات به حالت پیش‌فرض بازگردانده شوند؟')) {
                resetSettingsToDefault();
                playSound('click');
            }
        });

        fontSizeSlider.addEventListener('input', () => {
            fontSizeValue.textContent = `${fontSizeSlider.value}px`;
        });

        soundEffectsSlider.addEventListener('input', () => {
            soundEffectsValue.textContent = `${soundEffectsSlider.value}%`;
        });

        musicSelect.addEventListener('change', () => {
            if (musicSelect.value === 'none') {
                stopBackgroundMusic();
            } else {
                playBackgroundMusic(musicSelect.value);
            }
        });

        musicPlayBtn.addEventListener('click', () => {
            if (gameData.music.isPlaying) {
                pauseBackgroundMusic();
                musicPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
            } else {
                playBackgroundMusic(gameData.settings.selectedMusic);
                musicPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
            }
        });

        printBtn.addEventListener('click', () => {
            window.print();
            playSound('click');
        });

        saveBtn.addEventListener('click', () => {
            const story = getFullStory();
            const blob = new Blob([story], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `داستان_سفر_در_زمان_${gameData.playerName}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            playSound('click');
        });

        shareBtn.addEventListener('click', () => {
            const story = getFullStory();
            if (navigator.share) {
                navigator.share({
                    title: 'داستان سفر در زمان من',
                    text: story.substring(0, 100) + '...',
                    url: window.location.href
                }).catch(console.error);
            } else {
                alert('متأسفانه مرورگر شما از قابلیت اشتراک‌گذاری پشتیبانی نمی‌کند. می‌توانید داستان را ذخیره کنید.');
            }
            playSound('click');
        });

        restartBtn.addEventListener('click', () => {
            if (confirm('آیا مطمئن هستید که می‌خواهید بازی را از ابتدا شروع کنید؟ تمام پیشرفت شما از بین خواهد رفت.')) {
                resetGame();
                playSound('click');
            }
        });

        saveGameBtn.addEventListener('click', () => {
            saveGame();
            playSound('click');
        });

        loadGameBtn.addEventListener('click', () => {
            loadGame();
            playSound('click');
        });

        helpBtn.addEventListener('click', () => {
            showHelp();
            playSound('click');
        });

        // پخش موسیقی زمینه
        function playBackgroundMusic(track) {
            if (track === 'none') return;
            
            if (gameData.music.tracks[track]) {
                backgroundMusic.src = gameData.music.tracks[track];
                backgroundMusic.volume = gameData.settings.bgMusic / 100;
                backgroundMusic.play()
                    .then(() => {
                        gameData.music.isPlaying = true;
                        gameData.music.currentTrack = track;
                        musicPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    })
                    .catch(error => {
                        console.error('Error playing music:', error);
                        if (gameData.settings.onlineResources) {
                            alert('خطا در پخش موسیقی. لطفاً اتصال اینترنت خود را بررسی کنید.');
                        }
                    });
            }
        }

        function pauseBackgroundMusic() {
            backgroundMusic.pause();
            gameData.music.isPlaying = false;
        }

        function stopBackgroundMusic() {
            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;
            gameData.music.isPlaying = false;
            gameData.music.currentTrack = null;
            musicPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
        }

        // پخش افکت‌های صوتی
        function playSound(sound) {
            if (gameData.settings.soundEffects === 0) return;
            
            if (gameData.settings.onlineResources && gameData.onlineResources.sounds[sound]) {
                const audio = new Audio(gameData.onlineResources.sounds[sound]);
                audio.volume = gameData.settings.soundEffects / 100;
                audio.play().catch(error => {
                    console.error('Error playing sound:', error);
                });
            } else {
                // استفاده از افکت‌های صوتی ساده در صورت عدم اتصال
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                
                switch(sound) {
                    case 'click':
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(800, context.currentTime);
                        break;
                    case 'success':
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(1000, context.currentTime);
                        break;
                    case 'failure':
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(400, context.currentTime);
                        break;
                    default:
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(600, context.currentTime);
                }
                
                const gainNode = context.createGain();
                gainNode.gain.setValueAtTime(gameData.settings.soundEffects / 100, context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.2);
                
                oscillator.connect(gainNode);
                gainNode.connect(context.destination);
                
                oscillator.start();
                oscillator.stop(context.currentTime + 0.2);
            }
        }

        // اعمال تنظیمات
        function applySettings() {
            document.documentElement.setAttribute('data-theme', gameData.settings.theme);
            document.documentElement.style.setProperty('--font-size', `${gameData.settings.fontSize}px`);
            document.body.style.fontFamily = gameData.settings.fontFamily;
            backgroundMusic.volume = gameData.settings.bgMusic / 100;
            
            // اعمال تم بر اساس دوره تاریخی انتخاب شده
            if (gameData.selectedEra) {
                changeThemeByEra(gameData.selectedEra);
            }
            
            // به روزرسانی موسیقی اگر در حال پخش است
            if (gameData.music.isPlaying && gameData.settings.selectedMusic !== gameData.music.currentTrack) {
                if (gameData.settings.selectedMusic === 'none') {
                    stopBackgroundMusic();
                } else {
                    playBackgroundMusic(gameData.settings.selectedMusic);
                }
            }
            
            // ذخیره تنظیمات در localStorage
            localStorage.setItem('timeTravelerSettings', JSON.stringify(gameData.settings));
        }

        // بازنشانی تنظیمات به حالت پیش‌فرض
        function resetSettingsToDefault() {
            gameData.settings = {
                theme: "dark",
                fontSize: 18,
                fontFamily: "Vazirmatn",
                bgMusic: 50,
                soundEffects: 80,
                autoScroll: true,
                animationEffects: true,
                onlineResources: false,
                imageQuality: "medium",
                selectedMusic: "none",
                difficulty: "normal",
                autosave: 5
            };
            
            // به روزرسانی UI
            themeSelect.value = gameData.settings.theme;
            fontSizeSlider.value = gameData.settings.fontSize;
            fontSizeValue.textContent = `${gameData.settings.fontSize}px`;
            fontFamilySelect.value = gameData.settings.fontFamily;
            bgMusicSlider.value = gameData.settings.bgMusic;
            soundEffectsSlider.value = gameData.settings.soundEffects;
            soundEffectsValue.textContent = `${gameData.settings.soundEffects}%`;
            autoScrollCheckbox.checked = gameData.settings.autoScroll;
            animationEffectsCheckbox.checked = gameData.settings.animationEffects;
            onlineResourcesCheckbox.checked = gameData.settings.onlineResources;
            imageQualitySelect.value = gameData.settings.imageQuality;
            musicSelect.value = gameData.settings.selectedMusic;
            difficultySelect.value = gameData.settings.difficulty;
            autosaveSelect.value = gameData.settings.autosave;
            
            applySettings();
        }

        // تغییر تم بر اساس دوره تاریخی
        function changeThemeByEra(era) {
            if (era === 'hakhmaneshi') {
                document.documentElement.setAttribute('data-theme', 'hakhmaneshi');
            } else if (era === 'sasani') {
                document.documentElement.setAttribute('data-theme', 'sasani');
            } else if (era === 'safavid') {
                document.documentElement.setAttribute('data-theme', 'safavid');
            } else if (era === 'ghajar') {
                document.documentElement.setAttribute('data-theme', 'ghajar');
            } else if (era === 'pahlavi') {
                document.documentElement.setAttribute('data-theme', 'pahlavi');
            } else {
                document.documentElement.setAttribute('data-theme', gameData.settings.theme);
            }
        }

        // بارگذاری فصل
        function loadChapter(chapterId) {
            const chapter = storyChapters[chapterId];
            if (!chapter) return;
            
            gameData.currentChapter = chapterId;
            gameData.history.push(chapterId);
            gameData.stats.chaptersVisited++;
            
            // تغییر تم بر اساس دوره تاریخی اگر لازم باشد
            if (chapter.era && chapter.era !== gameData.selectedEra) {
                gameData.selectedEra = chapter.era;
                changeThemeByEra(chapter.era);
                gameData.stats.eraChanges++;
            }
            
            // اضافه کردن امتیاز اگر وجود دارد
            if (chapter.score) {
                addScore(chapter.score);
            }
            
            // جایگزینی نام بازیکن در متن
            let text = chapter.text.replace(/تو/g, gameData.playerName);
            text = text.replace(/نام بازیکن/g, gameData.playerName);
            
            if (gameData.playerGender === 'male') {
                text = text.replace(/تو به عنوان یک زن/g, 'تو به عنوان یک مرد');
                text = text.replace(/تو به عنوان زن/g, 'تو به عنوان مرد');
            }
            
            storyText.innerHTML = text;
            
            // نمایش تصویر اگر وجود دارد
            storyImageContainer.innerHTML = '';
            if (chapter.image) {
                const img = document.createElement('img');
                
                // استفاده از تصاویر آنلاین یا آفلاین
                if (gameData.settings.onlineResources) {
                    img.src = chapter.image;
                } else {
                    // در اینجا می‌توانید تصاویر جایگزین آفلاین را اضافه کنید
                    img.src = chapter.image; // فعلاً از همان تصاویر استفاده می‌کنیم
                }
                
                img.alt = 'تصویر داستان';
                img.className = 'story-image';
                storyImageContainer.appendChild(img);
            }
            
            // پاک کردن گزینه‌های قبلی
            choicesContainer.innerHTML = '';
            
            // اضافه کردن گزینه‌های جدید
            if (chapter.choices) {
                chapter.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.addEventListener('click', () => {
                        gameData.choices.push(choice.text);
                        gameData.stats.choicesMade++;
                        
                        // اضافه کردن امتیاز اگر وجود دارد
                        if (choice.score) {
                            addScore(choice.score);
                        }
                        
                        playSound('click');
                        
                        if (choice.next.startsWith('ending')) {
                            showEnding(choice.next);
                        } else {
                            loadChapter(choice.next);
                        }
                    });
                    choicesContainer.appendChild(button);
                });
            }
            
            // به روزرسانی نوار پیشرفت
            updateProgressBar();
            
            // اسکرول به پایین اگر تنظیمات اجازه دهد
            if (gameData.settings.autoScroll) {
                window.scrollTo(0, document.body.scrollHeight);
            }
            
            // ذخیره خودکار بازی
            if (gameData.settings.autosave > 0) {
                saveGame();
            }
        }

        // نمایش پایان
        function showEnding(endingId) {
            const ending = storyChapters[endingId];
            gameScreen.style.display = 'none';
            endScreen.style.display = 'block';
            
            if (endingId.includes('hero') || endingId.includes('wise') || endingId.includes('guardian')) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // اضافه کردن امتیاز پایان
            if (ending.score) {
                addScore(ending.score);
            }
            
            endTitle.textContent = ending.ending;
            
            // ایجاد محتوای پایان
            let content = `<h3>${ending.ending}</h3>`;
            content += `<div class="story-text">${ending.text}</div>`;
            
            if (ending.image) {
                content += `<img src="${ending.image}" alt="تصویر پایان" class="story-image">`;
            }
            
            content += `<div class="achievement">`;
            content += `<h4>داستان کامل ${gameData.playerName}:</h4>`;
            content += `<div class="story-text">${getFullStory()}</div>`;
            content += `</div>`;
            
            content += `<div class="stats">`;
            content += `<div class="stat-item"><div class="stat-value">${gameData.stats.chaptersVisited}</div><div>فصل بازدید شده</div></div>`;
            content += `<div class="stat-item"><div class="stat-value">${gameData.stats.choicesMade}</div><div>انتخاب انجام شده</div></div>`;
            content += `<div class="stat-item"><div class="stat-value">${gameData.stats.eraChanges}</div><div>تغییر دوره تاریخی</div></div>`;
            content += `<div class="stat-item"><div class="stat-value">${gameData.stats.achievementsUnlocked}</div><div>دستاورد باز شده</div></div>`;
            content += `<div class="stat-item"><div class="stat-value">${gameData.score}</div><div>امتیاز کل</div></div>`;
            content += `</div>`;
            
            content += `<p><strong>ساخته شده توسط حسام‌الدین</strong></p>`;
            
            endContent.innerHTML = content;
            
            // ذخیره بازی
            saveGame();
        }

        // گرفتن داستان کامل
        function getFullStory() {
            let fullStory = `سفر در زمان: ملاقات با تاریخ\n`;
            fullStory += `بازیکن: ${gameData.playerName}\n`;
            fullStory += `دوره تاریخی: ${gameData.selectedEra}\n`;
            fullStory += `پایان: ${storyChapters[gameData.currentChapter]?.ending || 'ناتمام'}\n`;
            fullStory += `امتیاز: ${gameData.score}\n\n`;
            
            gameData.history.forEach((chapterId, index) => {
                const chapter = storyChapters[chapterId];
                if (chapter) {
                    fullStory += `فصل ${index + 1}:\n`;
                    
                    // جایگزینی نام بازیکن در متن
                    let text = chapter.text.replace(/تو/g, gameData.playerName);
                    text = text.replace(/نام بازیکن/g, gameData.playerName);
                    
                    if (gameData.playerGender === 'male') {
                        text = text.replace(/تو به عنوان یک زن/g, 'تو به عنوان یک مرد');
                        text = text.replace(/تو به عنوان زن/g, 'تو به عنوان مرد');
                    }
                    
                    fullStory += text + "\n\n";
                    
                    if (gameData.choices[index]) {
                        fullStory += `انتخاب من: ${gameData.choices[index]}\n\n`;
                    }
                }
            });
            
            return fullStory;
        }

        // به روزرسانی نوار پیشرفت
        function updateProgressBar() {
            const totalChapters = Object.keys(storyChapters).length;
            const visitedChapters = new Set(gameData.history).size;
            const progress = (visitedChapters / totalChapters) * 100;
            
            gameProgress.style.width = `${progress}%`;
        }

        // بررسی اتصال به اینترنت
        function checkOnlineStatus() {
            if (!navigator.onLine && gameData.settings.onlineResources) {
                alert('اتصال اینترنت شما قطع است. برخی ویژگی‌ها ممکن است به درستی کار نکنند.');
                gameData.settings.onlineResources = false;
                onlineResourcesCheckbox.checked = false;
            }
        }

        // ذخیره بازی
        function saveGame() {
            const saveData = {
                gameData: gameData,
                timestamp: new Date().getTime()
            };
            
            localStorage.setItem('timeTravelerSave', JSON.stringify(saveData));
            alert('بازی با موفقیت ذخیره شد!');
        }

        // بارگذاری بازی
        function loadGame() {
            const saveData = JSON.parse(localStorage.getItem('timeTravelerSave'));
            
            if (!saveData) {
                alert('هیچ داده ذخیره‌شده‌ای یافت نشد.');
                return;
            }
            
            if (confirm('آیا می‌خواهید بازی ذخیره‌شده را بارگذاری کنید؟ پیشرفت فعلی شما از بین خواهد رفت.')) {
                Object.assign(gameData, saveData.gameData);
                
                // به روزرسانی UI
                scoreValue.textContent = gameData.score;
                
                // بارگذاری آخرین فصل
                if (gameData.currentChapter.startsWith('ending')) {
                    endScreen.style.display = 'block';
                    gameScreen.style.display = 'none';
                    showEnding(gameData.currentChapter);
                } else {
                    gameScreen.style.display = 'block';
                    eraScreen.style.display = 'none';
                    endScreen.style.display = 'none';
                    loadChapter(gameData.currentChapter);
                }
                
                alert('بازی با موفقیت بارگذاری شد!');
            }
        }

        // بازنشانی بازی
        function resetGame() {
            gameData.playerName = "";
            gameData.playerGender = "male";
            gameData.playerAge = 25;
            gameData.currentChapter = "start";
            gameData.selectedEra = "";
            gameData.history = [];
            gameData.achievements = [];
            gameData.choices = [];
            gameData.score = 0;
            gameData.inventory = [];
            gameData.stats = {
                chaptersVisited: 0,
                choicesMade: 0,
                eraChanges: 0,
                timeSpent: 0,
                achievementsUnlocked: 0,
                scoreEarned: 0
            };
            
            // بازنشانی دستاوردها
            for (const key in gameData.achievementsList) {
                gameData.achievementsList[key].unlocked = false;
            }
            
            // به روزرسانی UI
            scoreValue.textContent = "0";
            playerNameInput.value = "";
            playerGenderSelect.value = "male";
            playerAgeInput.value = "25";
            
            endScreen.style.display = 'none';
            gameScreen.style.display = 'none';
            eraScreen.style.display = 'none';
            startScreen.style.display = 'flex';
        }

        // نمایش راهنما
        function showHelp() {
            alert(`راهنمای بازی سفر در زمان:
            
1. شما می‌توانید به دوره‌های مختلف تاریخی سفر کنید.
2. هر انتخاب شما بر روند داستان تأثیر می‌گذارد.
3. سعی کنید امتیاز بیشتری کسب کنید و دستاوردها را باز کنید.
4. می‌توانید بازی را ذخیره و بعداً ادامه دهید.
5. از تنظیمات برای شخصی‌سازی بازی استفاده کنید.
            
موفق باشید!`);
        }

        // مقداردهی اولیه
        function init() {
            // ایجاد ذرات شناور
            createParticles();
            
            // بارگذاری تنظیمات ذخیره‌شده
            const savedSettings = localStorage.getItem('timeTravelerSettings');
            if (savedSettings) {
                gameData.settings = JSON.parse(savedSettings);
            }
            
            // بارگذاری بازی ذخیره‌شده
            const savedGame = localStorage.getItem('timeTravelerSave');
            if (savedGame) {
                if (confirm('بازی ذخیره‌شده پیدا شد. آیا می‌خواهید آن را بارگذاری کنید؟')) {
                    loadGame();
                    return;
                }
            }
            
            // بررسی وضعیت اتصال به اینترنت
            checkOnlineStatus();
            window.addEventListener('online', checkOnlineStatus);
            window.addEventListener('offline', checkOnlineStatus);
            
            // اعمال تنظیمات
            themeSelect.value = gameData.settings.theme;
            fontSizeSlider.value = gameData.settings.fontSize;
            fontSizeValue.textContent = `${gameData.settings.fontSize}px`;
            fontFamilySelect.value = gameData.settings.fontFamily;
            bgMusicSlider.value = gameData.settings.bgMusic;
            soundEffectsSlider.value = gameData.settings.soundEffects;
            soundEffectsValue.textContent = `${gameData.settings.soundEffects}%`;
            autoScrollCheckbox.checked = gameData.settings.autoScroll;
            animationEffectsCheckbox.checked = gameData.settings.animationEffects;
            onlineResourcesCheckbox.checked = gameData.settings.onlineResources;
            imageQualitySelect.value = gameData.settings.imageQuality;
            musicSelect.value = gameData.settings.selectedMusic;
            difficultySelect.value = gameData.settings.difficulty;
            autosaveSelect.value = gameData.settings.autosave;
            
            applySettings();
            
            // نمایش صفحه شروع
            startScreen.style.display = 'flex';
            nameScreen.style.display = 'none';
            eraScreen.style.display = 'none';
            gameScreen.style.display = 'none';
            endScreen.style.display = 'none';
            settingsPanel.style.display = 'none';
        }

        // شروع بازی
        init();
    </script>
</body>
</html>